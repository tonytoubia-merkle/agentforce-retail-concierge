<template>
    <!-- Customer Search -->
    <template if:false={hasSelectedCustomer}>
        <div class="panel-header">
            <h2 class="panel-title">Customer Profile</h2>
        </div>
        <c-customer-lookup oncustomerselected={handleCustomerSelected}></c-customer-lookup>
    </template>

    <!-- Selected Customer Profile -->
    <template if:true={hasSelectedCustomer}>
        <div class="panel-header">
            <div class="customer-header">
                <div class="customer-identity">
                    <h2 class="customer-name">{profile.name}</h2>
                    <span class={identityBadgeClass}>{profile.identityTier}</span>
                    <template if:true={profile.clientellingTier}>
                        <span class="clientelling-tier">{profile.clientellingTier}</span>
                    </template>
                </div>
                <div class="customer-contact">
                    <template if:true={profile.email}>
                        <span class="contact-detail">
                            <lightning-icon icon-name="utility:email" size="xx-small"></lightning-icon>
                            {profile.email}
                        </span>
                    </template>
                    <template if:true={profile.phone}>
                        <span class="contact-detail">
                            <lightning-icon icon-name="utility:call" size="xx-small"></lightning-icon>
                            {profile.phone}
                        </span>
                    </template>
                </div>
                <div class="header-actions">
                    <lightning-button-icon
                        icon-name="utility:refresh"
                        alternative-text="Refresh profile"
                        onclick={handleRefreshProfile}
                        class="slds-m-right_x-small"
                    ></lightning-button-icon>
                    <lightning-button-icon
                        icon-name="utility:close"
                        alternative-text="Close profile"
                        onclick={handleCloseProfile}
                    ></lightning-button-icon>
                </div>
            </div>

            <!-- Today's Appointment Banner -->
            <template if:true={hasTodaysAppointment}>
                <div class="appointment-banner">
                    <lightning-icon icon-name="utility:event" size="x-small" class="slds-m-right_x-small"></lightning-icon>
                    <span class="appt-type">{profile.todaysAppointment.type_x}</span>
                    <span class="appt-time">{profile.todaysAppointment.appointmentDateTime}</span>
                    <span class={appointmentStatusClass}>{profile.todaysAppointment.status}</span>
                </div>
            </template>
        </div>

        <!-- Loading -->
        <template if:true={isLoading}>
            <div class="slds-align_absolute-center slds-p-around_large">
                <lightning-spinner alternative-text="Loading profile" size="medium"></lightning-spinner>
            </div>
        </template>

        <!-- 360 Profile Sections -->
        <template if:false={isLoading}>
            <div class="profile-content">
                <c-profile-section360 profile={profile}></c-profile-section360>
            </div>

            <!-- Consultation Note Capture -->
            <div class="note-capture-section">
                <c-consultation-note-capture
                    contact-id={selectedContactId}
                    appointment-id={currentAppointmentId}
                    onnoteadded={handleNoteAdded}
                ></c-consultation-note-capture>
            </div>
        </template>
    </template>
</template>
